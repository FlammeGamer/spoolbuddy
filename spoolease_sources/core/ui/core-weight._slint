// This is left in project as _slint because it has several techniques that might be useful in the future

import { MyButton, Title, Selector, LeftTab, HorizontalSelector, MyText } from "framework/widgets.slint";
import { NumPad } from "numpad.slint";
import { AppState, AppBackend, ControlState, SpoolScaleState } from "app.slint";

export component AdvertisedWeightSelector inherits HorizontalSelector {
    public function index-from-weight(weight: int) -> int {
        weight == 200 ? 0 : weight == 250 ? 1 : weight == 500 ? 2 : weight == 750 ? 3 : weight == 800 ? 4 : weight == 1000 ? 5 : weight == 0 ? 6 : weight == 1100 ? 7 : weight == 2000 ? 8 : weight == 2268 ? 9 : weight == 2500 ? 10 : weight == 3000 ? 12 : 6;
    }
    property <[int]> weights-grams: [200, 250, 500, 750, 800, 1000, 0, 1100, 2000, 2268, 2500, 3000];
    out property <int> selected-weight: weights-grams[self.selected-option-index];
    options: [
        "200g",
        "250g",
        "500g",
        "750g",
        "800g",
        "1kg",
        "-",
        "1.1kg",
        "2kg",
        "5lbs",
        "2.5kg",
        "3kg"
    ];
    default-option-index: 6;  // 0 
        }

export component CoreEstimate inherits Rectangle {
    in property <int> advertised-weight: 0;
    background: white;
    border-color: black;
    border-width: 1px;
    VerticalLayout {
        padding-left: 10px;
        padding-right: 10px;
        padding-top: 24px;
        padding-bottom: 24px;
        alignment: space-between;
        MyText {
            vertical-alignment: top;
            height: 20px;
            text: "Use this estimator only with unused spools!";
        }

        VerticalLayout {
            spacing: 10px;
            // padding-left: 10px;
            Text {
                height: 24px;
                vertical-alignment: top;
                text: "Current measured weight";
                font-size: 20px;
            }

            HorizontalLayout {
                // padding-right: 10px;
                spacing: 20px;
                VerticalLayout {
                    spacing: 10px;
                    current-measured-weight := Rectangle {
                        width: 264px;
                        height: 30px;
                        border-color: black;
                        border-width: 1px;
                        background: AppState.spool-scale-state == SpoolScaleState.Disconnected || AppState.spool-scale-state == SpoolScaleState.Uncalibrated ? orangered : AppState.spool-scale-state == SpoolScaleState.Connected ? lightgreen : AppState.spool-scale-state == SpoolScaleState.Loaded && !AppState.spool-scale-weight-stable ? yellow : lightskyblue;
                        Text {
                            font-size: 20px;
                            text: AppState.spool-scale-state == SpoolScaleState.Disconnected ? "Scale Disconnected" : AppState.spool-scale-state == SpoolScaleState.Uncalibrated ? "Scale Not Calibrated" : AppState.spool-scale-state == SpoolScaleState.Connected ? "Scale Connected" : AppState.spool-scale-state == SpoolScaleState.Loaded ? "\{AppState.spool-scale-weight}g" : "";
                        }
                    }

                    Text {
                        height: 24px;
                        vertical-alignment: top;
                        text: "Estimated Spool Core Weight";
                        font-size: 20px;
                    }

                    displayed-weight := Rectangle {
                        property <int> calculated-core: AppState.spool-scale-weight - advertised-weight;
                        width: 264px;
                        height: 30px;
                        border-color: black;
                        border-width: 2px;
                        background: lightskyblue;
                        Text {
                            font-size: 20px;
                            text: calculated-core > 0 ? "\{calculated-core}" : "";
                        }
                    }
                }

                VerticalLayout {

                    MyButton {
                        enabled: displayed-weight.calculated-core > 0;
                        text: "Ok";
                        clicked => {
                            AppState.encode-set-core-info(root.advertised-weight, displayed-weight.calculated-core, AppState.spool-scale-weight, "");
                            AppState.encoding-spool-core-visible = false;
                        }
                    }
                }
            }
        }
    }
}

export component SelectIfNewSpool inherits Rectangle {
    callback cancel-clicked;
    callback yes-clicked;
    callback no-clicked;
    background: white;
    VerticalLayout {
        alignment: center;
        padding: 20px;
        HorizontalLayout {
            VerticalLayout {
                width: parent.width / 2;
                measured-weight-title := Text {
                    horizontal-alignment: center;
                    vertical-alignment: center;
                    height: 30px;
                    text: "Spool measured weight";
                    font-size: 20px;
                }

                HorizontalLayout {
                    alignment: center;
                    Rectangle {
                        width: 155px;
                        height: 30px;
                        background: lightskyblue;
                        border-color: black;
                        border-width: 1px;
                        Text {
                            horizontal-alignment: center;
                            vertical-alignment: center;
                            height: 30px;
                            text: "\{AppState.spool-scale-weight}g";
                            font-size: 20px;
                        }
                    }
                }
            }

            VerticalLayout {
                width: parent.width / 2;
                core-weight-title := Text {
                    horizontal-alignment: center;
                    vertical-alignment: center;
                    height: 30px;
                    text: "Entered core weight";
                    font-size: 20px;
                }

                HorizontalLayout {
                    alignment: center;
                    Rectangle {
                        width: 155px;
                        height: 30px;
                        background: lightskyblue;
                        border-color: black;
                        border-width: 1px;
                        Text {
                            horizontal-alignment: center;
                            vertical-alignment: center;
                            height: 30px;
                            text: "\{AppState.core-weight-to-encode-after-select-if-new}g";
                            font-size: 20px;
                        }
                    }
                }
            }
        }

        Text {
            vertical-alignment: center;
            height: 30px;
            text: "";
            font-size: 20px;
        }

        Text {
            vertical-alignment: center;
            height: 30px;
            text: "Encode this as a new Spool?";
            font-size: 20px;
        }

        Text {
            vertical-alignment: center;
            height: 30px;
            text: "Press 'Yes' only if this is an unused Spool";
            font-size: 20px;
        }

        Text {
            vertical-alignment: center;
            height: 30px;
            text: "";
            font-size: 20px;
        }

        HorizontalLayout {
            padding-top: 10px;
            alignment: center;
            spacing: 40px;
            yes := MyButton {
                height: 56px;
                width: 120px;
                text: "Yes";
                clicked => {
                    root.yes-clicked();
                }
            }

            no := MyButton {
                height: 56px;
                width: 120px;
                text: "No";
                clicked => {
                    root.no-clicked();
                }
            }

            cancel := MyButton {
                height: 56px;
                width: 120px;
                text: "Cancel";
                clicked => {
                    // root.state = SpoolCoreWeightState.EntryTabs;
                    root.cancel-clicked()
                }
            }
        }
    }
}

export component Keyboard inherits Rectangle {
    in property <length> buttons-height: 48px;
    in property <length> buttons-width: 48px;
    callback clicked-ok;
    callback clicked-cancel();
    in-out property <string> typed-text;
    property <[[string]]> keys: [
        ["Q", "W", "E", "R", "T", "Y", "U", "I", "O", "P"],
        ["A", "S", "D", "F", "G", "H", "J", "K", "L"],
        ["Z", "X", "C", "V", "B", "N", "M"],
        ["3", "-", " "],
    ];
    callback key-clicked(char: string);
    background: white;
    VerticalLayout {
        Rectangle {
            background: beige;
            height: buttons-height;
            width: root.width;
            Text {
                text: root.typed-text;
                font-size: 20px;
            }
        }

        for row[y] in keys: HorizontalLayout {
            Rectangle {
                width: y * (buttons-width * 1.6 / 1.9 / 2);
            } // ratio taken roughly from Mac Keyboard)
            for col in row: MyButton {
                height: buttons-height;
                width: self.text == " " ? 2 * buttons-width : buttons-width;
                text: col;
                clicked => {
                    root.typed-text = "\{root.typed-text}\{self.text}";
                }
            }
        }
    }

    HorizontalLayout {
        x: root.width - buttons-width * 4;
        y: root.height - buttons-height;
        MyButton {
            width: buttons-width * 2;
            height: buttons-height;
            text: "Ok";
            clicked => {
                root.clicked-ok();
            }
        }

        MyButton {
            width: buttons-width * 2;
            height: buttons-height;
            text: "Cancel";
            clicked => {
                root.clicked-cancel();
            }
        }
    }
}

enum SpoolCoreWeightState {
    EntryTabs,
    NewSpoolSelect,
}
export component SpoolCoreWeight inherits Rectangle {
    width: 480px;
    height: 320px;
    property <SpoolCoreWeightState> state: SpoolCoreWeightState.EntryTabs;
    property <bool> show-keyboard;

    // The following two tracking properties are tricky - to update the selected spool advertised weight
    // when core-select dialog is displayed and when request label weight is changed from web ui
    property <bool> track-spool-core-visible: AppState.encoding-spool-core-visible;
    changed track-spool-core-visible => {
        if track-spool-core-visible {
            advertised-weight.selected-option-index = advertised-weight.index-from-weight(AppState.curr-encode-request.weight-advertised);
            advertised-weight.centerd-option-index = advertised-weight.selected-option-index;
        }
    }
    property <int> track-request-weight-advertised: AppState.curr-encode-request.weight-advertised;
    changed track-request-weight-advertised => {
        advertised-weight.selected-option-index = advertised-weight.index-from-weight(AppState.curr-encode-request.weight-advertised);
        advertised-weight.centerd-option-index = advertised-weight.selected-option-index;
    }

    background: black;
    select-if-new-spool := SelectIfNewSpool {
        visible: state == SpoolCoreWeightState.NewSpoolSelect;
        cancel-clicked => {
            root.state = SpoolCoreWeightState.EntryTabs;
        }
        no-clicked => {
            AppState.encode-set-core-info(advertised-weight.selected-weight,AppState.core-weight-to-encode-after-select-if-new, 0, AppState.core-name-to-encode-after-select-if-new);
            AppState.encoding-spool-core-visible = false;
            root.state = SpoolCoreWeightState.EntryTabs; // for next time
        }
        yes-clicked => {
            AppState.encode-set-core-info(advertised-weight.selected-weight, AppState.core-weight-to-encode-after-select-if-new, AppState.spool-scale-weight, AppState.core-name-to-encode-after-select-if-new);
            AppState.encoding-spool-core-visible = false;
            root.state = SpoolCoreWeightState.EntryTabs; // for next time
        }
    }

    VerticalLayout {
        visible: state == SpoolCoreWeightState.EntryTabs;
        alignment: stretch;

        advertised-weight := AdvertisedWeightSelector {
            height: 48px;
            min-button-width: 86px;
            buttons-width: 56px;
        }

        // Rectangle {
            title := Title {
            height: 32px;
            text: "Spool Core Weight - " + (show-keyboard ? "Filter List" : (tabs.selected-text == "List" ? "Select from List" : tabs.selected-text == "Est" ? "Estimate for New Spool" : tabs.selected-text == "1234" ? "Manually Entered" : ""));
            z: 1;
        }

        Window {
            HorizontalLayout {
                height: root.height - title.height - advertised-weight.height;

                tabs := LeftTab {
                    buttons-height: 48px;
                    // height: root.height - title.height;
                    tabs: AppState.spool-scale-state == SpoolScaleState.Loaded ? ["List", "1234", "Est"] : ["List", "1234"];
                    bottom-tab: "Cancel";
                    botom-tab-pressed => {
                        AppState.encoding-spool-core-visible = false;
                    }
                    width: 70px;
                }

                tab-cards := Window {
                    width: root.width - tabs.width;

                    select-list := Selector {
                        filter-button-height: 48px;
                        page-buttons-height: 48px;
                        thumb-height: 48px;
                        option-height: 48px;
                        property <string> filter;
                        changed filter => {
                            self.jump-to(0);
                        }

                        filter-clicked => {
                            show-keyboard = true;
                        }
                        selected(text, pos-in-list, id) => {
                            AppState.core-name-to-encode-after-select-if-new = text;
                            AppState.core-weight-to-encode-after-select-if-new = AppBackend.get-spool-core-weight(id);
                            // if AppState.spool-scale-state == SpoolScaleState.Loaded {
                            //     root.state = SpoolCoreWeightState.NewSpoolSelect;
                            // } else {
                            AppState.encode-set-core-info(advertised-weight.selected-weight, AppState.core-weight-to-encode-after-select-if-new, 0, AppState.core-name-to-encode-after-select-if-new);
                            AppState.encoding-spool-core-visible = false;
                            root.state = SpoolCoreWeightState.EntryTabs; // for next time
                            // }
                        }
                        visible: tabs.selected-text == "List";
                        preferred-width: 1000px;
                        option-alignment: left;
                        options-list: AppBackend.get-spools-core-list(filter);
                    }

                    estimate := CoreEstimate {
                        visible: tabs.selected-text == "Est";
                        advertised-weight: advertised-weight.selected-weight;
                    }

                    type-weight := Rectangle {
                        visible: tabs.selected-text == "1234";
                        background: black;
                        HorizontalLayout {
                            width: root.width - tabs.width;
                            alignment: space-around;
                            NumPad {
                                max-digits: 3;
                                height: tabs.height;
                                ok-clicked => {
                                    AppState.core-name-to-encode-after-select-if-new = "Custom: \{self.number}g";
                                    AppState.core-weight-to-encode-after-select-if-new = self.number;
                                    // if AppState.spool-scale-state == SpoolScaleState.Loaded {
                                    //     root.state = SpoolCoreWeightState.NewSpoolSelect;
                                    // } else {
                                        AppState.encode-set-core-info(advertised-weight.selected-weight, AppState.core-weight-to-encode-after-select-if-new, 0, AppState.core-name-to-encode-after-select-if-new);
                                    AppState.encoding-spool-core-visible = false;
                                    root.state = SpoolCoreWeightState.EntryTabs; // for next time
                                    // }
                                }
                            }
                        }
                    }
                }
            }

            if show-keyboard: Keyboard {
                clicked-ok => {
                    select-list.filter = self.typed-text;
                    show-keyboard = false;
                }
                clicked-cancel => {
                    show-keyboard = false;
                }
            }
        }
    }
}
