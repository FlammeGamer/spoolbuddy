import { FrameworkState, OtaState, Log } from "framework/framework.slint";
import { SelectorOption } from "framework/widgets.slint";
import { SelectorOptionsList } from "framework/widgets.slint";
// Types

export enum UiTrayState { Unknown, Empty, Spool, Reading, Ready, Loading, Unloading, Loaded }
// Spool - Spool entered the slot but not yet processed by AMS, so not ready yet
// Ready - there is a spool, it is not loaded to the extruder now
// Loading - during the process of loading into the extruder
// Loaded - in the extruder
// Unloading - during the process of unloading from the extruder
export enum UiFilamentState { Unknown, Known }

export struct UiFilament {
  state: UiFilamentState,
  color: color,
  material: string,
}

export struct UiTray {
  id: int,
  external: bool,
  spool-state: UiTrayState,
  filament: UiFilament,
  k: string,
  tagged: bool,
  weight-display: string,
  used-in-print: bool,
  spool_rec_id: string,
}

export struct UiSpoolRecord {
    id: string,
    tag_id: string,
    material-type: string,
    material-subtype: string,
    color-name: string,
    color-code: string,
    note: string,
    brand: string,
    weight-advertised: int,
    weight-core: int,
    weight-new: int,
    weight-current: int,
    slicer-filament: string,
    // added-time: int,
    // encode-time: int,
    added-full: bool,
    consumed-since-add: float,
    consumed-since-weight: float,
    ext-has-k: bool,
}

export struct UiSpoolRecordDisplay {
  spool_record: UiSpoolRecord,
  slicer-filament-name: string,
  color: color,
  temp-min: int,
  temp-max: int,
  pa-line1: string,
  pa-line2: string,
  weight-left: string,
}

export struct UiSlotDisplay {
  filament-title: string,
  slicer-name: string,
  color-code: string,
  temp-min: int,
  temp-max: int,
  pa: string,
  consumed-since-loaded: float,
  available-in-spool: float,
}

// Consts

export global AppConsts {
    out property <length> trays-spacing: 4px;
    out property <length> external-tray-separator: 2px;
    out property <brush> no-color: @linear-gradient(45deg, #fff 0%, #333 100%);
    out property <brush> title-gradient: @linear-gradient(180deg, #09009B 0%, #0000CA 39%, #001dff 100%);
    // out property <brush> no-color: @linear-gradient(45deg, #fff 0%, #AAA 54%, #333 100%);
    // out property <brush> no-color: @linear-gradient(180deg, #fff 0%, #666 50%, #333 100%);
}

export enum ControlState {
  Booting,
  BootFailed,
  Ready,
  Reading, // can probably be colapsed into Ready as a note
  NewTagScan,
  StagingSelected, // To load
  // FilamentInformation,
  TraySelect, // for selecting a tray when loading filament from staging
  TraySelected, // just selecting tray (unrelated to previous)
  Encoding, // can probably be collapsed
  Erasing, // can probably be collapsed
  PostAction, // can probably be collapsed
}

export enum SpoolScaleState {
  NotAvailable,
  Unknown,
  Uncalibrated,
  Disconnected,
  Connected,
  Empty,
  Loaded,
}

export enum StatusType {
  Normal,
  Success,
  Error
}

export enum SpoolStagingState {
  Empty,
  Scanned,
  Encoded,
  Unloaded,
  Unchanged,
}

// Functions to call rust
export global AppBackend {
    callback clear-staging();
    callback set-staging-to-tray(tray-id: int);
    callback encode-tag() -> bool;
    callback read-tag-mode();
    callback web-config-web-app();
    callback select-printer(printer: string);
    callback calibrate-scale(weight: int);
    pure callback get-connected-scale-info() -> string;
    pure callback get-available-scales-info() -> [string];
    callback import-definition-tag-to-inventory(tag-definition-type: string, tag-definition-info: string, empty-spool-weight: int);
    callback link_tag_to_spool_id(tag_id: string, tag_type: string, spool-id: string, final-step: bool);
    callback unlink-spool-from-tag(spool-id: string);
    callback set-spool-weight(spool-id: string, weight_current: int, weight_new: int, final-step: bool);
    pure callback recently_added_spool_id_if_untagged() -> string;
    pure callback get-spool-record-display(spool-id: string) -> UiSpoolRecordDisplay;
    pure callback get-spool-tag-definition-display(tag-definition-type: string, tag-definition-info: string, empty-spool-weight: int) -> UiSpoolRecordDisplay;
    pure callback get-slot-display(tray-id: int) -> UiSlotDisplay;
    callback can-link-spool-to-tag(id: string) -> string; // empty if untagged, error text if not
    callback add-v1-tag-to-inventory(tag_id: string, tag_descriptor: string, final-step: bool);
    callback erase-tag(tag_id: string) -> bool;
    callback erase-tag-by-spool-id(id: string) -> bool;
    callback untag-slot(tray-id: int);
    callback reset-slot(tray-id: int);
    callback configure-slot-with-spool-id(tray-id: int, spool-id: string);
    callback ota-check-firmwares();
    callback ota-update-firmware(product: string, train: string);
}

export enum NewScannedTagType {
  SimpleTag,
  DefinitionTag,
}

export enum NewTagScanPage {
    OperationSelect,
    SpoolSelect,
    SpoolDisplay,
    UpdateWeight,
    StatusDisplay,
    V1TagPrompt,
    SpoolDefinitionTagScanned, // Bambulab etc.
    BambulabSpoolTypeSelection,
    ImportDefinitionNotice,
}

export enum NewTagOperation {
  None,
  LinkTagToSpoolId,
  LinkTagToRecentlyAddedSpool,
  AddV1TagToInventory, // V1
  EraseV1Tag, // V1
}

export enum StagingOperationsPage {
  SpoolDisplay,
  OperationSelection,
  UpdateWeight,
}

export struct Firmwares {
  console-curr: string,
  console-stable: string,
  console-stable-newer: bool,
  console-unstable: string,
  console-unstable-newer: bool,
  console-debug: string,
  console-debug-newer: bool,
  scale-curr: string,
  scale-stable: string,
  scale-stable-newer: bool,
  scale-unstable: string,
  scale-unstable-newer: bool,
  scale-debug: string,
  scale-debug-newer: bool,
}

export global AppState {
    in-out property <Firmwares> firmwares: {
        console-curr: "console-curr",
        console-stable: "console-stable",
        console-stable-newer: false,
        console-unstable: "console-unstable",
        console-unstable-newer: false,
        console-debug: "console-debug",
        console-debug-newer: false,
        scale-curr: "scale-curr",
        scale-stable: "scale-stable",
        scale-stable-newer: false,
        scale-unstable: "scale-unstable",
        scale-unstable-newer: false,
        scale-debug: "scale-debug",
        scale-debug-newer: false,
    };

    in-out property <string> message-box-title;
    in-out property <string> message-box-text;
    in-out property <string> message-box-text2;
    in-out property <StatusType> message-box-type;
    in-out property <int> message-box-timeout;

    in-out property <[UiTray]> trays-state: self.empty-trays-state();
    in-out property <bool> select-printer: false;
    in-out property <ControlState> control-state: ControlState.Booting;
    changed control-state => {
        self.stop-highlight-trays();
    }
    in-out property <bool> some-printer-connected: false;

    // Global state variables for New Tag Scan Control-State
    in-out property <NewScannedTagType> new-tag-scan-tag-type; // Simple or Definition
    in-out property <string> new-tag-scan-tag-id: "";
    in-out property <NewTagScanPage> new-tag-scan-page: OperationSelect;
    in-out property <string> new-tag-scan-status: ""; // text means error, empty mean ok
    in-out property <NewTagOperation> new-tag-operation: None;
    in-out property <string> new-tag-scan-spool-id: "";
    in-out property <int> new-tag-scan-spool-id-int: 0; // used for when typing the id
    in-out property <string> new-tag-scan-definition-info: ""; // The actual data (as understdoon by the view_model)
    in-out property <string> new-tag-scan-definition-type: ""; // Bambu Lab, Creatlity, etc.
    in-out property <int> new-tag-scan-empty-spool-weight: 0; // 0 - not specified, value from Bambu Tag

    in-out property <StagingOperationsPage> staging-operation-page: StagingOperationsPage.OperationSelection;
    in-out property <StagingOperationsPage> prev-staging-operation-page: StagingOperationsPage.OperationSelection;

    // Global state for TraySelected Control-State
    in-out property <int> tray-selected-tray-index: -1;

    in-out property <SpoolStagingState> spool-staging-state: SpoolStagingState.Empty;
    in-out property <UiSpoolRecordDisplay> spool-staging-info;
    in-out property <int> staging-to-tray: -1; // tray that needs to be updated with filament when recognizing on backend tray is reading
    in-out property <bool> reset-staging-countdown: false;

    in-out property <string> user-message: "Booting ...";
    in-out property <StatusType> user-message-type: StatusType.Normal;

    // TODO: find a better name
    // in-out property <string> spool-inventory-dialog-message: "";
    // in-out property <StatusType> spool-inventory-dialog-type: StatusType.Normal;

    in-out property <int> encode-timeout: 999;
    in-out property <int> erase-timeout: 999;

    in-out property <int> curr-ams-id: 0;
    in-out property <[int]> ams-exists: [0];

    in-out property <string> curr-printer: "";
    in-out property <int> num-extruders: 1;
    in-out property <int> displayed-extruder: 0;
    in-out property <[string]> available-printers: [];
    in-out property <string> default-printer: "";
    in-out property <string> pending-curr-printer: "";
    changed pending-curr-printer => {
        if pending-curr-printer != "" {
            AppBackend.select-printer(pending-curr-printer);
            pending-curr-printer = "";
        }
    }

    in-out property <SpoolScaleState> spool-scale-state: SpoolScaleState.Unknown;
    in-out property <int> spool-scale-weight: 0;
    in-out property <bool> spool-scale-weight-stable: false;
    in-out property <int> spool-scale-raw-data: 0;
    in-out property <bool> spool-scale-flash: false;
    in-out property <SpoolScaleState> spool-scale-after-flash-state: SpoolScaleState.Unknown;

    in-out property <bool> highlight-trays: false;
    in-out property <bool> highlight-staging: false;
    in-out property <int> highlight-tray: -1;
    in-out property <bool> highlight-tray-flash: false;
    out property <int> highlight-tray-counter-length: 20;
    in-out property <int> highlight-tray-counter: highlight-tray-counter-length;

    public pure function ui-tray-spool-state-name(state: UiTrayState) -> string {
        if state == UiTrayState.Unknown {
            return "Unknown";
        }
        if state == UiTrayState.Empty {
            return "Slot is Empty";
        }
        if state == UiTrayState.Spool {
            return "Spool Placed";
        }
        if state == UiTrayState.Reading {
            return "Reading Filament Information";
        }
        if state == UiTrayState.Ready {
            return "Spool in Slot, Idle";
        }
        if state == UiTrayState.Loading {
            return "Retracting From Extruder";
        }
        if state == UiTrayState.Unloading {
            return "Loading Into Extruder";
        }
        if state == UiTrayState.Loaded {
            return "In Extruder";
        }
        return "-";
    }

    public function start-highlight-tray(tray-id: int) {
        self.highlight-tray = tray-id;
        self.highlight-tray-counter = highlight-tray-counter-length;
    }
    public function start-highlight-tray-forever(tray-id: int) {
        self.highlight-tray = tray-id;
        self.highlight-tray-counter = -1; // number even/odd to sync this tray flashing with other flashings
    }
    public function stop-highlight-tray() {
        AppState.highlight-tray = -1;
        AppState.highlight-tray-flash = false;
        AppState.highlight-tray-counter = AppState.highlight-tray-counter-length;
    }
    public function stop-highlight-trays() {
        AppState.highlight-trays = false;
        AppState.highlight-staging = false;
    }

// Functions called locally fom Rust

    // timeout -1 is default as coded here, 0 is no timeout (stays on until ok), positive number - timeout in seconds
    public function show-message-box(title: string, text: string, text2: string, type: StatusType, timeout: int) {
        self.message-box-title = title == "" ? "Message" : title;
        self.message-box-text = text;
        self.message-box-text2 = text2;
        self.message-box-type = type;
        self.message-box-timeout = (timeout == -1 ? 10 : timeout);
    }

    public function hide-message-box() {
        self.message-box-title = "";
        self.message-box-text = "";
        self.message-box-text2 = "";
        self.message-box-type = StatusType.Normal;
        self.message-box-timeout = 0;
    }

    public function printer-connected(printer-name: string) {
        if self.control-state == ControlState.Booting /*|| self.control-state == ControlState.ConnectingToPrinter*/ {
            self.control-state = ControlState.Ready;
        }
        self.some-printer-connected = true;
    }

    public function initialization_completed() {
        if self.control-state == ControlState.Booting {
            self.control-state = ControlState.Ready;
        }
    }

    public function boot-failed(status: string) {
        self.control-state = ControlState.BootFailed;
        self.user-message = status;
        self.user-message-type = StatusType.Error;
    }

    public function read-tag-found() {
        if self.control-state == ControlState.Ready {
            self.control-state = ControlState.Reading;
            self.user-message = "Tag to Read Found,\nReading ...";
            self.user-message-type = StatusType.Normal;
        }
    }
    public function read-tag-failed(err-txt: string) {
        if self.control-state == ControlState.Reading {
            self.control-state = ControlState.PostAction;
            self.user-message = "Scanning Tag Failed\n\{err-txt}";
            self.user-message-type = StatusType.Error;
        }
    }
    public function read-tag-succeeded(ui-spool-info: UiSpoolRecordDisplay, final-step: bool) {
        self.spool-staging-state = SpoolStagingState.Scanned;
        self.spool-staging-info = ui-spool-info;
        self.user-message = "Tag Scanned to Staging";
        self.user-message-type = StatusType.Success;
        start-highlight-tray(999);
        if final-step {
            self.control-state = ControlState.PostAction;
        }
    }

    public function tag-unloaded(ui-spool-info: UiSpoolRecordDisplay) {
        self.spool-staging-state = SpoolStagingState.Unloaded;
        self.spool-staging-info = ui-spool-info;
        self.control-state = ControlState.PostAction;
        self.user-message = "Tag Unloaded to Staging";
        self.user-message-type = StatusType.Normal;
        start-highlight-tray(999);
    }

    public function update-spool-staging(ui-spool-info: UiSpoolRecordDisplay, state: SpoolStagingState) {
        self.spool-staging-info = ui-spool-info;
        if state != SpoolStagingState.Unchanged {
            self.spool-staging-state = state;
            start-highlight-tray(999);
        }
    }

    public function updated-spool-weight(spool-id: string, from_button: bool) {
        self.show-message-box("Inventory Notice", "Updated Spool \{spool-id} Weight", "", StatusType.Success, -1);
        if !from_button && (self.control-state == ControlState.StagingSelected || self.control-state == ControlState.NewTagScan) {
            self.control-state = ControlState.Ready;
        }
    }

    public function empty-spool-staging() {
        self.spool-staging-state = SpoolStagingState.Empty;
        self.spool-staging-info = {};
        // self.spool-staging-info.spool-record.weight-core = 0;
    }

    public function spool-loaded-when-staging-loaded() {
        self.reset-staging-countdown = true;
    }

    // TODO: names are ok, but should be changed for encoding a spool-id
    public function encode-tag-found() {
        self.control-state = ControlState.Encoding;
        self.user-message = "Tag Found, Encoding ...";
        self.user-message-type = StatusType.Normal;
    }

    public function erase-tag-found() {
        self.control-state = ControlState.Erasing;
        self.user-message = "Tag Found, Erasing ...";
        self.user-message-type = StatusType.Normal;
    }

    public function encoding-failure(err-txt: string) {
        // this is just a termporary failure, not final, can still try placing tag to encode, so NOT PostAction
        self.user-message = "Encoding Tag Error\n\{err-txt}";
        self.user-message-type = StatusType.Error;
    }

    public function erasing-failure(err-txt: string) {
        // this is just a termporary failure, not final, can still try placing tag to encode, so NOT PostAction
        self.user-message = "Erasing Tag Error\n\{err-txt}";
        self.user-message-type = StatusType.Error;
    }

    public function encoding-succeeded() {
        self.control-state = ControlState.PostAction;
        self.user-message = "Encoding Succeeded";
        self.user-message-type = StatusType.Success;
    }

    public function erasing-succeeded() {
        self.control-state = ControlState.PostAction;
        self.user-message = "Erasing Succeeded";
        self.user-message-type = StatusType.Success;
    }

    public function tray-update-failed(printer: string, configured-entity: string, err-txt: string) {
        self.control-state = ControlState.PostAction;
        self.user-message = "Failed to Configure\n\{configured-entity}\n\{err-txt}";
        self.user-message-type = StatusType.Error;
    }

    // ams-id here is as follows : 0..3 (normal), 4.. (HT), 255 (external)
    // tray-id is the tray number inside the AMS (in HT all are 0) or 254/255 for external
    public function tray-update-succeeded(printer: string, configured-entity: string, tray-id: int) {
        self.control-state = ControlState.PostAction;
        self.user-message = "Configured Successfully\n\{configured-entity}";
        self.user-message-type = StatusType.Success;
        start-highlight-tray(tray-id);
        if printer != self.curr-printer {
            self.set-later-curr-printer(printer)
        }
    }

    pure public function get_tray_id(ams-id: int, tray-id: int) -> int {
        if ams-id <= 3 {
            return ams-id * 4 + tray-id;
        }
        if ams-id <= 3 + 8 {
            return 16 + ams-id - 4;
        }
        return ams-id; // 254 or 255
    }

    pure public function get_tray_index(ams-id: int, tray-id: int) -> int {
        if ams-id <= 3 {
            return ams-id * 4 + tray-id + 2;
        }
        if ams-id <= 3 + 8 {
            return 16 + ams-id - 4 + 2;
        }
        if ams_id == 254 {
            return 1;
        } else {
            return 0;
        }
    }

    public function staging-selected() {
        self.staging-operation-page = StagingOperationsPage.SpoolDisplay;
        self.control-state = ControlState.StagingSelected;
    }

    public function tray-selected(tray-index: int) {
        self.tray-selected-tray-index = tray-index;
        self.control-state = ControlState.TraySelected;
    }

    public function prompt-select-tray() {
        self.tray-selected-tray-index = -1;
        AppState.control-state = ControlState.Ready;
    }

    // Called from UI in case of UI timeout, can also be called from backend for timeout case
    public function encoding-timeout() {
        self.control-state = ControlState.PostAction;
        self.user-message = "Encoding Tag Timed Out";
        self.user-message-type = StatusType.Error;

        AppBackend.read-tag-mode();
        // don't call encode-cancel() becasue on timeout we want to show timeout first on display
    }

    public function encode-cancel() {
        AppBackend.read-tag-mode();
        self.control-state = ControlState.Ready;
    }

    public function encode-start() {
        if AppBackend.encode-tag() { // return value of 0 means there was an error, error will be reported separately
            self.encode-timeout = 15;
            self.control-state = ControlState.Encoding;
            user-message = "Place Spool Tag\nto Encode";
            user-message-type = StatusType.Normal;
        }
    }

    public function erasing-timeout() {
        self.control-state = ControlState.PostAction;
        self.user-message = "Erasing Tag Timed Out";
        self.user-message-type = StatusType.Error;

        AppBackend.read-tag-mode();
    }

    public function erasing-cancel() {
        AppBackend.read-tag-mode();
        self.control-state = ControlState.Ready;
    }

    public function erase-tag-by-spool-id-start(spool-id: string) {
        if AppBackend.erase-tag-by-spool-id(spool-id) {
            self.erase-timeout = 15;
            self.control-state = ControlState.Erasing;
            user-message = "Place Spool Tag\nto Erase";
            user-message-type = StatusType.Normal;
        }
    }

    public function erase-tag-by-tag-id-start(tag-id: string) {
        if AppBackend.erase-tag(tag-id) {
            self.erase-timeout = 15;
            self.control-state = ControlState.Erasing;
            user-message = "Place Spool Tag\nto Erase";
            user-message-type = StatusType.Normal;
        }
    }

    pure public function is-scale-usable-now() -> bool {
        return self.spool-scale-state == SpoolScaleState.Connected || self.spool-scale-state == SpoolScaleState.Empty || self.spool-scale-state == SpoolScaleState.Loaded || self.spool-scale-state == SpoolScaleState.Disconnected;
    }

    public function spool-scale-connected() {
        self.spool-scale-state = SpoolScaleState.Connected;
        self.spool-scale-flash = true;
        self.spool-scale-after-flash-state = SpoolScaleState.Empty;
    }

    public function spool-scale-disconnected() {
        self.spool-scale-state = SpoolScaleState.Disconnected;
        self.spool-scale-flash = false;
        self.spool-scale-after-flash-state = SpoolScaleState.Disconnected;
    }

    public function spool-scale-uncalibrated() {
        self.spool-scale-state = SpoolScaleState.Uncalibrated;
        self.spool-scale-flash = false;
        self.spool-scale-after-flash-state = SpoolScaleState.Uncalibrated;
    }

    public function spool-scale-loaded(weight: int, stable: bool) {
        self.spool-scale-state = SpoolScaleState.Loaded;
        self.spool-scale-weight = weight;
        self.spool-scale-weight-stable = stable;
        self.spool-scale-flash = true;
        self.spool-scale-after-flash-state = SpoolScaleState.Loaded;
    }

    public function spool-scale-load-changed(weight: int, stable: bool) {
        // This is only case of load changed, NOT removed
        self.spool-scale-weight = weight;
        self.spool-scale-weight-stable = stable;
    }

    public function spool-scale-load-removed() {
        self.spool-scale-state = SpoolScaleState.Empty;
        self.spool-scale-weight = 0;
        self.spool-scale-weight-stable = false;
        self.spool-scale-flash = false;
        self.spool-scale-after-flash-state = SpoolScaleState.Empty;
    }
    public function spool_scale_raw_samples_avg(raw-data: int) {
        self.spool-scale-raw-data = raw-data;
    }

    public function emulated-tag-scanned() {
    }

    public function set-printers-info(available-printers: [string], default_printer: string) {
        self.available-printers = available-printers;
        self.default-printer = default-printer;
    }

    public function set-curr-printer(curr-printer: string) {
        self.curr-printer = curr_printer;
    }
    // the below is a function to call with delay the select-printer
    // to avoid rust's borrowing issues in the implementation
    // uses property changed for delayed call
    public function set-later-curr-printer(curr-printer: string) {
        self.pending-curr-printer = curr-printer
    }

    // Rust callable functions for new-tag-scan flow
    public function new-tag-scanned(tag-id: string) {
        self.new-tag-scan-page = NewTagScanPage.OperationSelect;
        self.new-tag-scan-tag-type = NewScannedTagType.SimpleTag;
        self.new-tag-operation = NewTagOperation.None;
        self.new-tag-scan-status = "";
        self.new-tag-scan-spool-id = "";
        self.new-tag-scan-spool-id-int = 0;
        self.new-tag-scan-tag-id = tag-id;
        self.new-tag-scan-definition-info = "";
        self.new-tag-scan-empty-spool-weight = 0;
        self.control-state = ControlState.NewTagScan;
    }
    public function new-v1-tag-scanned(tag-id: string, v1-tag: string) {
        self.new-tag-scan-page = NewTagScanPage.V1TagPrompt;
        self.new-tag-scan-tag-type = NewScannedTagType.SimpleTag;
        self.new-tag-operation = NewTagOperation.None;
        self.new-tag-scan-status = "";
        self.new-tag-scan-spool-id = "";
        self.new-tag-scan-spool-id-int = 0;
        self.new-tag-scan-tag-id = tag-id;
        self.new-tag-scan-definition-info = v1-tag;
        self.new-tag-scan-empty-spool-weight = 0;
        self.control-state = ControlState.NewTagScan;
    }
    public function new-definition-tag-scanned(definition-type: string, tag-id: string, definition-info: string) {
        self.new-tag-scan-definition-type = definition-type; // Bambu Lab, OpenPrintTag, Creality, etc. - in the future can unite with V1-Tag
        self.new-tag-scan-tag-type = NewScannedTagType.DefinitionTag;
        self.new-tag-scan-page = NewTagScanPage.SpoolDefinitionTagScanned;
        self.new-tag-operation = NewTagOperation.None;
        self.new-tag-scan-status = "";
        self.new-tag-scan-spool-id = "";
        self.new-tag-scan-spool-id-int = 0;
        self.new-tag-scan-tag-id = tag-id;
        self.new-tag-scan-definition-info = definition-info;
        self.new-tag-scan-empty-spool-weight = 0;
        self.control-state = ControlState.NewTagScan;
    }

    public function import-definition-tag-to-inventory-status(status: string, spool-id: string) {
      // This one is called both from link_tag and from v1_tag add new tag flows
      // string empty ok, content is error message

      if self.control-state == ControlState.NewTagScan {
            if status == "" {
          // this will be effective only if there is a weight (this will be driven by the flow in the screen itself)
                self.new-tag-scan-spool-id = spool-id;
                self.new-tag-scan-page = NewTagScanPage.ImportDefinitionNotice;
            } else {
                self.new-tag-scan-page = NewTagScanPage.StatusDisplay;
                self.new-tag-scan-status = status;
            }
        }
    }

    public function link-tag-to-spool-id-status(status: string) {
      // string empty ok, content is error message

      if self.control-state == ControlState.NewTagScan {
            if status == "" {
          // this will be effective only if there is a weight (this will be driven by the flow in the screen itself)
                self.new-tag-scan-page = NewTagScanPage.UpdateWeight;
            } else {
                self.new-tag-scan-page = NewTagScanPage.StatusDisplay;
                self.new-tag-scan-status = status;
            }
        }
    }

    public function add-v1-tag-to-inventory-status(status: string, spool-id: string) {
      // This one is called both from link_tag and from v1_tag add new tag flows
      // string empty ok, content is error message

      if self.control-state == ControlState.NewTagScan {
            if status == "" {
          // this will be effective only if there is a weight (this will be driven by the flow in the screen itself)
                self.new-tag-scan-spool-id = spool-id;
                self.new-tag-scan-page = NewTagScanPage.UpdateWeight;
            } else {
                self.new-tag-scan-page = NewTagScanPage.StatusDisplay;
                self.new-tag-scan-status = status;
            }
        }
    }

    public function unlink-spool-id-from-tag-status(spool-id: string, status: string) {
      // string empty ok, content is error message
      if status == "" {
            self.show-message-box("Unlink Notice", "Spool \{spool-id} Unlinked From Tag", "", StatusType.Success, 10);
            if self.control-state == ControlState.StagingSelected {
                self.control-state = ControlState.Ready
            }
        } else {
            self.show-message-box("Unlink Notice", "Failed to Unlink Spool \{spool-id} From Tag", status, StatusType.Error, 10);
        }
    }

    public function notify-available-firmwares(firmwares: Firmwares) {
        self.firmwares = firmwares;
        if FrameworkState.ota-state == OtaState.Checking {
            FrameworkState.ota-state = OtaState.UserInput;
        }
    }

    pure public function stable-firmware-updates-available() -> bool {
        return self.firmwares.console-stable-newer || self.firmwares.scale-stable-newer;
    }

    pure public function unstable-firmware-updates-available() -> bool {
        return self.firmwares.console-unstable-newer || self.firmwares.scale-unstable-newer;
    }

    function empty-trays-state() -> [UiTray] {
        return [
  // External (Right)
            {
                id: 255,
                external: true,
                spool-state: UiTrayState.Unknown,
                filament: {
                    state: UiFilamentState.Unknown,
                    color: #000,
                    material: "???",
                },
                k: -1.0,
                tagged: false,
                spool_rec_id: "",
                weight-display: "",
                used-in-print: false,
            },

  // External (Right)
            {
                id: 254,
                external: true,
                spool-state: UiTrayState.Unknown,
                filament: {
                    state: UiFilamentState.Unknown,
                    color: #000,
                    material: "???",
                },
                k: -1.0,
                tagged: false,
                spool_rec_id: "",
                weight-display: "",
                used-in-print: false,
            },

  // AMS: 0
            {
                id: 0,
                external: false,
                spool-state: UiTrayState.Unknown,
                filament: {
                    state: UiFilamentState.Unknown,
                    color: #000,
                    material: "???",
                },
                k: -1.0,
                tagged: false,
                spool_rec_id: "",
                weight-display: "",
                used-in-print: false,
            },
            {
                id: 1,
                external: false,
                spool-state: UiTrayState.Unknown,
                filament: {
                    state: UiFilamentState.Unknown,
                    color: #000,
                    material: "???",
                },
                k: -1.0,
                tagged: false,
                spool_rec_id: "",
                weight-display: "",
                used-in-print: false,
            },
            {
                id: 2,
                external: false,
                spool-state: UiTrayState.Unknown,
                filament: {
                    state: UiFilamentState.Unknown,
                    color: #000,
                    material: "???",
                },
                k: -1.0,
                tagged: false,
                spool_rec_id: "",
                weight-display: "",
                used-in-print: false,
            },
            {
                id: 3,
                external: false,
                spool-state: UiTrayState.Unknown,
                filament: {
                    state: UiFilamentState.Unknown,
                    color: #000,
                    material: "???",
                },
                k: -1.0,
                tagged: false,
                spool_rec_id: "",
                weight-display: "",
                used-in-print: false,
            },

  // AMS 1
            {
                id: 4,
                external: false,
                spool-state: UiTrayState.Unknown,
                filament: {
                    state: UiFilamentState.Unknown,
                    color: #000,
                    material: "???",
                },
                k: -1.0,
                tagged: false,
                spool_rec_id: "",
                weight-display: "",
                used-in-print: false,
            },
            {
                id: 5,
                external: false,
                spool-state: UiTrayState.Unknown,
                filament: {
                    state: UiFilamentState.Unknown,
                    color: #000,
                    material: "???",
                },
                k: -1.0,
                tagged: false,
                spool_rec_id: "",
                weight-display: "",
                used-in-print: false,
            },
            {
                id: 6,
                external: false,
                spool-state: UiTrayState.Unknown,
                filament: {
                    state: UiFilamentState.Unknown,
                    color: #000,
                    material: "???",
                },
                k: -1.0,
                tagged: false,
                spool_rec_id: "",
                weight-display: "",
                used-in-print: false,
            },
            {
                id: 7,
                external: false,
                spool-state: UiTrayState.Unknown,
                filament: {
                    state: UiFilamentState.Unknown,
                    color: #000,
                    material: "???",
                },
                k: -1.0,
                tagged: false,
                spool_rec_id: "",
                weight-display: "",
                used-in-print: false,
            },
  // AMS 2
            {
                id: 8,
                external: false,
                spool-state: UiTrayState.Unknown,
                filament: {
                    state: UiFilamentState.Unknown,
                    color: #000,
                    material: "???",
                },
                k: -1.0,
                tagged: false,
                spool_rec_id: "",
                weight-display: "",
                used-in-print: false,
            },
            {
                id: 9,
                external: false,
                spool-state: UiTrayState.Unknown,
                filament: {
                    state: UiFilamentState.Unknown,
                    color: #000,
                    material: "???",
                },
                k: -1.0,
                tagged: false,
                spool_rec_id: "",
                weight-display: "",
                used-in-print: false,
            },
            {
                id: 10,
                external: false,
                spool-state: UiTrayState.Unknown,
                filament: {
                    state: UiFilamentState.Unknown,
                    color: #000,
                    material: "???",
                },
                k: -1.0,
                tagged: false,
                spool_rec_id: "",
                weight-display: "",
                used-in-print: false,
            },
            {
                id: 11,
                external: false,
                spool-state: UiTrayState.Unknown,
                filament: {
                    state: UiFilamentState.Unknown,
                    color: #000,
                    material: "???",
                },
                k: -1.0,
                tagged: false,
                spool_rec_id: "",
                weight-display: "",
                used-in-print: false,
            },
  // AMS 3
            {
                id: 12,
                external: false,
                spool-state: UiTrayState.Unknown,
                filament: {
                    state: UiFilamentState.Unknown,
                    color: #000,
                    material: "???",
                },
                k: -1.0,
                tagged: false,
                spool_rec_id: "",
                weight-display: "",
                used-in-print: false,
            },
            {
                id: 13,
                external: false,
                spool-state: UiTrayState.Unknown,
                filament: {
                    state: UiFilamentState.Unknown,
                    color: #000,
                    material: "???",
                },
                k: -1.0,
                tagged: false,
                spool_rec_id: "",
                weight-display: "",
                used-in-print: false,
            },
            {
                id: 14,
                external: false,
                spool-state: UiTrayState.Unknown,
                filament: {
                    state: UiFilamentState.Unknown,
                    color: #000,
                    material: "???",
                },
                k: -1.0,
                tagged: false,
                spool_rec_id: "",
                weight-display: "",
                used-in-print: false,
            },
            {
                id: 15,
                external: false,
                spool-state: UiTrayState.Unknown,
                filament: {
                    state: UiFilamentState.Unknown,
                    color: #000,
                    material: "???",
                },
                k: -1.0,
                tagged: false,
                spool_rec_id: "",
                weight-display: "",
                used-in-print: false,
            },
  // AMS-HT: 4
            {
                id: 16,
                external: false,
                spool-state: UiTrayState.Unknown,
                filament: {
                    state: UiFilamentState.Unknown,
                    color: #000,
                    material: "???",
                },
                k: -1.0,
                tagged: false,
                spool_rec_id: "",
                weight-display: "",
                used-in-print: false,
            },
  // AMS-HT: 5
            {
                id: 17,
                external: false,
                spool-state: UiTrayState.Unknown,
                filament: {
                    state: UiFilamentState.Unknown,
                    color: #000,
                    material: "???",
                },
                k: -1.0,
                tagged: false,
                spool_rec_id: "",
                weight-display: "",
                used-in-print: false,
            },
  // AMS-HT: 6
            {
                id: 18,
                external: false,
                spool-state: UiTrayState.Unknown,
                filament: {
                    state: UiFilamentState.Unknown,
                    color: #000,
                    material: "???",
                },
                k: -1.0,
                tagged: false,
                spool_rec_id: "",
                weight-display: "",
                used-in-print: false,
            },
  // AMS-HT: 7
            {
                id: 19,
                external: false,
                spool-state: UiTrayState.Unknown,
                filament: {
                    state: UiFilamentState.Unknown,
                    color: #000,
                    material: "???",
                },
                k: -1.0,
                tagged: false,
                spool_rec_id: "",
                weight-display: "",
                used-in-print: false,
            },

  // AMS-HT: 8
        {
                id: 20,
                external: false,
                spool-state: UiTrayState.Unknown,
                filament: {
                    state: UiFilamentState.Unknown,
                    color: #000,
                    material: "???",
                },
                k: -1.0,
                tagged: false,
                spool_rec_id: "",
                weight-display: "",
                used-in-print: false,
            },
  // AMS-HT: 9
            {
                id: 21,
                external: false,
                spool-state: UiTrayState.Unknown,
                filament: {
                    state: UiFilamentState.Unknown,
                    color: #000,
                    material: "???",
                },
                k: -1.0,
                tagged: false,
                spool_rec_id: "",
                weight-display: "",
                used-in-print: false,
            },
  // AMS-HT: 10 
            {
                id: 22,
                external: false,
                spool-state: UiTrayState.Unknown,
                filament: {
                    state: UiFilamentState.Unknown,
                    color: #000,
                    material: "???",
                },
                k: -1.0,
                tagged: false,
                spool_rec_id: "",
                weight-display: "",
                used-in-print: false,
            },
  // AMS-HT: 11 
            {
                id: 23,
                external: false,
                spool-state: UiTrayState.Unknown,
                filament: {
                    state: UiFilamentState.Unknown,
                    color: #000,
                    material: "???",
                },
                k: -1.0,
                tagged: false,
                spool_rec_id: "",
                weight-display: "",
                used-in-print: false,
            },
        ];
    }
}
