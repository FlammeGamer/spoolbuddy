<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SpoolEase Configuration</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" href="favicon-48x48.png" sizes="48x48">
  </head>
  <body>
    <h1>SpoolEase Configuration</h1>
    <h3 style="text-align: center;">Most configurations require device restart</h3>

    <!-- Security Key Section -->
    <div class="section" id="security-section">
      <h2 class="section-title">Security Key</h2>
      <p>IMPORTANT: A security key is required to configure the settings below.
         You can find it in the settings screen beneath the terminal and main screens.
         If it‚Äôs not visible, swipe vertically on the SpoolEase console display to reveal it.</p>
      <div id="verify-key-section">
        <div class="form-row">
          <label for="security-key"
            >Key: * <span>Fill and verify key before configuring</span></label
          >
          <input
            type="text"
            id="security-key"
            placeholder="Enter security key"
            autocomplete="off" spellcheck="false" autocapitalize="off" autocorrect="off"
          />
        </div>

        <button
          id="verify-key-button"
          type="button"
          class="secondary apply-btn"
          onclick="applyKeyFetchConfigs()"
          disabled
        >
          Verify Key & Load Config
        </button>
        <label class="feedback-label" id="security-key-feedback"></label>
      </div>
      <div id="set-fixed-key-section">
        <div class="form-row" style="margin-top: 20px">
          <label for="fixed-security-key"
            >Set a Fixed Security Key:<span
              >Optional, applies after restart</span
            ></label
          >
          <input
            type="text"
            id="fixed-security-key"
            placeholder="Enter fixed security key"
            autocomplete="off" spellcheck="false" autocapitalize="off" autocorrect="off"
          />
        </div>

        <button
          id="set-fixed-key-apply"
          type="button"
          class="apply-btn"
          onclick="applyFixedSecurityKeySettings()"
          disabled
        >
          Apply
        </button>
      </div>
    </div>

    <!-- WiFi Credentials Section -->
    <div class="section" id="wifi-section">
      <h2 class="section-title">WiFi Credentials</h2>

      <div class="form-row">
        <label for="wifi-ssid">SSID: *</label>
        <input
          type="text"
          id="wifi-ssid"
          placeholder="Enter WiFi network name"
          autocomplete="off" spellcheck="false" autocapitalize="off" autocorrect="off"
        />
      </div>

      <div class="form-row">
        <label for="wifi-password">Password: *</label>
        <div class="password-container">
          <input
            type="password"
            id="wifi-password"
            placeholder="Enter WiFi password"
            autocomplete="off" spellcheck="false" autocapitalize="off" autocorrect="off"
          />
          <span
            class="toggle-password"
            onclick="togglePasswordVisibility('wifi-password', this)"
            >üëÅÔ∏è</span
          >
        </div>
      </div>

      <button
        id="wifi-section-apply"
        type="button"
        class="apply-btn"
        onclick="applyWiFiSettings()"
        disabled
      >
        Apply
      </button>
    </div>

    <!-- Device Name -->
    <div class="section" id="device-name-section">
      <h2 class="section-title">Device Name</h2>
      <div class="form-row">
        <label for="device-name"
          >Device Name:<span>mDNS (http://devicename.local)</span></label
        >
        <input
          type="text"
          maxlength="63"
          pattern="[a-zA-Z0-9-]{1,63}"
          oninput="filterDnsName(this)"
          id="device-name"
          placeholder="Enter Device Name"
          autocomplete="off" spellcheck="false" autocapitalize="off" autocorrect="off"
        />
      </div>

      <button
        id="device-name-apply"
        type="button"
        class="apply-btn"
        onclick="applyDeviceNameSettings()"
        disabled
      >
        Apply
      </button>
    </div>

    <!-- Display Settings Section -->
    <div class="section" id="display-section">
      <h2 class="section-title">Display Settings</h2>

      <div class="form-row">
        <label for="dimming-timeout">Dimming Timeout (in seconds): *</label>
        <input
          type="number"
          id="dimming-timeout"
          min="0"
          placeholder="Enter timeout"
        />
      </div>

      <div class="form-row">
        <label for="dimming-percent">Dimming Percent (0-100%): *</label>
        <input
          type="number"
          id="dimming-percent"
          min="0"
          max="100"
          placeholder="Enter percentage"
        />
      </div>

      <div class="form-row">
        <label for="blackout-timeout">Blackout Timeout (in seconds): *</label>
        <input
          type="number"
          id="blackout-timeout"
          min="0"
          placeholder="Enter timeout"
        />
      </div>

      <button
        id="display-section-apply"
        type="button"
        class="apply-btn"
        onclick="applyDisplaySettings()"
        disabled
      >
        Apply
      </button>
    </div>

    <!-- Printer Settings Section -->
    <div class="section" id="printer-section">
        <h2 class="section-title">Printer Settings</h2>

        <div id="printers-container">
          <!-- Printer forms will be added here dynamically -->
        </div>

        <div class="button-container">
          <button
            id="printers-apply"
            type="button"
            class="apply-btn"
            onclick="applyPrintersSettings()"
            disabled
          >
            Apply
          </button>
        </div>
      </div>

      <!-- Scale Settings -->
      <div class="section" id="scale-section">
        <h2 class="section-title">Scale Settings</h2>
        <div class="form-row" style="display: flex; flex-direction: row; gap: 6px;">
          <input type="Checkbox" id="scale-available"><label for="scale-available">SpoolEase Scale Available</label>
        </div>

        <div class="form-row">
          <label for="scale-key"
            >Scale Security Key: *
            </label
          >
          <input
            type="text"
            id="scale-key"
            placeholder="Enter Scale Security Key"
            autocomplete="off" spellcheck="false" autocapitalize="off" autocorrect="off"
          />
        </div>


        <div class="form-row">
          <label for="scale-name"
            >Scale Device Name:<span
              >Optional, in case of several scales</span
            ></label
          >
          <input
            type="text"
            id="scale-name"
            placeholder="Enter Scale Device Name"
            autocomplete="off" spellcheck="false" autocapitalize="off" autocorrect="off"
          />
        </div>

        <div class="form-row">
          <label
          >Scale IP Address:<span
            >Optional, instead of auto discovery</span
          ></label
        >
        <div class="ip-container">
          <div class="ip-segment">
            <input
              type="text"
              class="ip-part"
              maxlength="3"
              placeholder="000"
            />
          </div>
          <div class="ip-segment">
            <input
              type="text"
              class="ip-part"
              maxlength="3"
              placeholder="000"
            />
          </div>
          <div class="ip-segment">
            <input
              type="text"
              class="ip-part"
              maxlength="3"
              placeholder="000"
            />
          </div>
          <div class="ip-segment">
            <input
              type="text"
              class="ip-part"
              maxlength="3"
              placeholder="000"
            />
          </div>
        </div>
        <div class="error-message ip-error">
          IP requires name to be provided
        </div>
      </div>

      <button
        id="scale-apply"
        type="button"
        class="apply-btn"
        onclick="applyScaleSettings()"
        disabled
      >
        Apply
      </button>
    </div>

    <!-- Filaments Section -->
    <div class="section" id="filaments-section">
      <h2 class="section-title">Custom Slicer Filaments</h2>

      <div class="form-row">
        <div style="display: flex; align-items: center; gap: 10px;>
            <label for="custom-filaments-text"
              >Custom Filaments CSV:</label
            >
            <button class="add-btn" style="margin-left:auto" type="button" onclick="selectAndProcessCustomFilaments()">Create List (On Desktop)</button>
            <input id="folderInput" type="file"  style="display:none" webkitdirectory multiple onchange="processFiles(event)" />
        </div>
        <textarea
          class="csv-text"
          id="custom-filaments-text"
          oninput="handleCSVTextAreaInput(event, 'custom-filaments-text', 'custom-filaments-chars-left', 4000)"
          placeholder="- Example (don't fill manually - normally should be auto generated):
P714fe8c,ELEGOO PLA Pro,190,240,PLA
Pd7bcff9,FLASHFORGE ASA Basic,240,280,ASA
Pda16356,SUNLU PLA PLA + 2,190,240,PLA"
        ></textarea>

        <div style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 10px;">
          <span id="custom-filaments-chars-left" class="csv-chars-left">0</span>
        </div>
        <p><b>First, add your custom filaments <a href="https://wiki.bambulab.com/en/bambu-studio/create-filament">in the slicer</a>.</b></p>
        
        <p>Then, press <b>"Create List"</b> Button and Select Folder as Explained Here:</p>
        <label>On MacOS</label>
          <p class="i0">/Users</p>
          <p class="i1">/{user-name}</p>
          <p class="i2">/Library &nbsp;&nbsp;&nbsp;‚ü∏ hidden, use CMD+SHIFT+'.' to unhide</p>
          <p class="i3">/Application Support</p>
          <p class="i4">/BambuStudio or OrcaSlicer</p>
          <p class="i5">/user</p>
        <label>On Windows</label>
          <p class="i0">C:\Users</p>
          <p class="i1">\{user-name}</p>
          <p class="i2">\AppData</p>
          <p class="i3">\Roaming</p>
          <p class="i4">\BambuStudio or OrcaSlicer</p>
          <p class="i5">\user</p>
      </div>

      <button
        id="filaments-apply"
        type="button"
        class="apply-btn"
        onclick="applyFilamentsSettings()"
        disabled
      >
        Apply
      </button>
    </div>

    <!-- Spools Weights Section -->
    <div class="section" id="spools-section">
      <h2 class="section-title">My Spools List</h2>

      <div class="form-row">
        <label for="spools-text"
          >Spools CSV:<a href="/spools-catalog" target="_blank"
            >SpoolEase Spools Catalog</a
          ></label
        >
        <textarea
          class="csv-text"
          id="spools-text"
          oninput="handleCSVTextAreaInput(event, 'spools-text', 'spools-chars-left', 2000)"
          placeholder="- Example (weight is also in the description for display):
eSUN - Plastic (Clear) - 209g,209
ProtoPasta 500g - Cardboard - 84g,84"
        ></textarea>
        <p id="spools-chars-left" class="csv-chars-left">abcd</p>
        <label>Sources for spool weights (sometimes with photos)</label>
        <ul>
          <li class="link-bullet">
            <a target="_blank" href="https://www.onlyspoolz.com/portfolio/"
              >OnlySpoolz (included in SpoolEase Catalog)</a
            ><br />
          </li>
          <li class="link-bullet">
            <a
              target="_blank"
              href="https://www.printables.com/model/464663-empty-spool-weight-catalog"
              >Scuk's Catalog (included in SpoolEase Catalog)</a
            >
          </li>
          <li class="link-bullet">
            <a
              target="_blank"
              href="https://www.reddit.com/r/3Dprinting/comments/4hlwse/empty_spool_weights_for_estimating_remaining/"
              >Reddit discussion</a
            >
          </li>
          <li class="link-bullet">
            <a
              target="_blank"
              href="https://3dprinting.stackexchange.com/questions/6558/is-there-a-table-or-list-of-tare-weights-of-empty-spools-of-various-manufacturer"
              >StackExchange discussion</a
            >
          </li>
          <li class="link-bullet">
            <a
              target="_blank"
              href="https://github.com/Donkie/SpoolmanDB/tree/main/filaments"
              >SpoolmanDB (inaccuracies found)</a
            >
          </li>
        </ul>
        <button
          id="spools-apply"
          type="button"
          class="apply-btn"
          onclick="applySpoolsSettings()"
          disabled
        >
          Apply
        </button>
      </div>
    </div>


    <!-- OTA Section -->

    <div class="section" id="ota-section">
      <h2 class="section-title">Network Firmware Upgrade</h2>

      <div class="form-row">
        <label for="curr-version">Current firmware version. For none release versions (beta/debug), update from console:</label>
        <p class="status-text" id="curr-version"></p>
      </div>

      <button
        id="ota-request"
        type="button"
        class="apply-btn"
        onclick="requestOta()"
        disabled
        style="margin-bottom: 10px"
      >
        Start Network Upgrade
      </button>

      <div class="form-row">
        <label for="ota-status">OTA Status:</label>
        <div style="display: flex; flex-direction: row;align-items: center;">
          <p style="height: 3rem" class="status-text" id="ota-status"></p>
          <button
             style="height: 3rem"
            class="next-to-status-button "
            id="ota-status-update"
            type="button"
            onclick="fetchOtaStatus()"
            disabled
          >
            Update<br/>Status
          </button>
        </div>
      </div>
    </div>

    <!-- General Section -->
    <div class="section" id="general-section">
      <h2 class="section-title">General</h2>

      <button
        id="restart-device"
        type="button"
        class="danger apply-btn"
        onclick="restartDevice()"
        disabled
      >
        Restart Device
      </button>
    </div>

    <script type="module">
      // Importing WASM as a JS module requires us to call an init function provided by the default export.
      // This is planned to be changed in the future.
      import {
        default as wasm,
        derive_key,
        encrypt,
        decrypt,
      } from "./pkg/device_wasm.js";
      // initialize wasm
      console.log("Waiting for wasm to initialize");
      await wasm();
      console.log("Wasm initialized");
      window.securityKeyOnDerive = "";
      window.encryptionKey = derive_key("", "example_salt");
      window.derive_key = derive_key;
      window.decrypt = decrypt;
      window.encrypt = encrypt;
      document.body.style.display = "block";

      const secKeyOnUrl = getHashParam('sk');
      if (secKeyOnUrl) {
        document.getElementById("security-key").value = secKeyOnUrl;
        applyKeyFetchConfigs();
      }
    </script>
    <script>
      async function sendData(inurl, data, retries = 5) {
        // data is object, not json string
        const url = `${urlPrefix}${inurl}`;
        let encryptionKey = getEncryptionKey();
        const response = await retryOperation(
          () =>
            fetch(url, {
              method: "POST",
              headers: { "Content-Type": "application/text" },
              body: encrypt(encryptionKey, JSON.stringify(data)),
            }),
          retries,
        );
        return response;
      }

      // Utility function to collect form data and send to the server
      async function sendConfigData(url, data, applyButton) {
        try {
          let response = await sendData(`${url}`, data);
          if (!response.ok) throw new Error(`Error: ${response.statusText}`);
          const encryptedText = await response.text();
          const decryptedText = decrypt(encryptionKey, encryptedText);
          const result = JSON.parse(decryptedText);
          alert(`Settings applied successfully, restart is required!!!`);
          if (applyButton) {
            applyButton.disabled = true;
          }
        } catch (error) {
          alert(`Failed to apply settings: ${error.message}`);
        }
      }

      function getEncryptionKey() {
        const securityKey = document
          .getElementById("security-key")
          .value.trim();
        if (securityKey != window.securityKeyOnDerive) {
          window.encryptionKey = derive_key(securityKey, "example_salt");
          window.securityKeyOnDerive = securityKey;
        }
        return window.encryptionKey;
      }
      // Function to test key
      async function applyKeyFetchConfigs() {
        const data = { test: "Hello" };
        try {
          let response = await sendData("/api/test-key", data); // Replace with actual server endpoint
          document.getElementById("device-name-apply").disabled = true;
          document.getElementById("wifi-section-apply").disabled = true;
          document.getElementById("set-fixed-key-apply").disabled = true;
          document.getElementById("display-section-apply").disabled = true;
          document.getElementById("printers-apply").disabled = true;
          document.getElementById("scale-apply").disabled = true;
          document.getElementById("spools-apply").disabled = true;
          if (response.status == 400) {
            document.getElementById("security-key-feedback").textContent = "Security Key is incorrect";
            document.getElementById("ota-request").disabled = true;
            document.getElementById("ota-status-update").disabled = true;
            document.getElementById("restart-device").disabled = true;
            return;
          } else if (response.ok) {
            document.getElementById("security-key-feedback").textContent = "Security Key validated";
            document.getElementById("verify-key-button").disabled = true;
            document.getElementById("ota-request").disabled = false;
            document.getElementById("ota-status-update").disabled = false;
            document.getElementById("restart-device").disabled = false;
          }
        } catch (error) {
          document.getElementById("security-key-feedback").textContent =
            `Failed to check key, try again (${error.message})`;
          return;
        }
        try {
          await fetchSectionConfigs();
        } catch (error) {
          document.getElementById("security-key-feedback").textContent +=
            " but Failed to Load Configs";
        }
      }

      async function retryOperation(operation, retries = 5) {
        for (let i = 0; i < retries; i++) {
          try {
            return await operation();
          } catch (error) {
            if (i === retries - 1) throw error; // Throw error if it's the last retry
          }
        }
      }

      async function fetchSectionConfigs() {
        await retryOperation(() => fetchWifiInitialConfig());
        await retryOperation(() => fetchOtaStatus());
        await retryOperation(() => fetchDisplayInitialConfig());
        await retryOperation(() => fetchPrinterInitialConfig());
        await retryOperation(() => fetchSpoolsInitialConfig());
        await retryOperation(() => fetchFilamentsInitialConfig());
        await retryOperation(() => fetchScaleInitialConfig());
        await retryOperation(() => fetchDeviceNameInitialConfig());
      }

      async function fetchInitialSectionConfig(section) {
        try {
          const response = await fetch(`${urlPrefix}/api/${section}-config`); // Replace with actual endpoint
          if (!response.ok) throw new Error(`Error: ${response.statusText}`);
          const encryptedText = await response.text();
          const decryptedText = decrypt(encryptionKey, encryptedText);
          const data = JSON.parse(decryptedText);

          // Populate WiFi credentials
          return data;
        } catch (error) {
          console.error(`Failed to fetch ${section} configuration:`, error);
          return null;
        }
      }

      async function fetchWifiInitialConfig() {
        const data = await fetchInitialSectionConfig("wifi");

        if (data) {
          document.getElementById("wifi-ssid").value = data.ssid;
          document.getElementById("wifi-password").value = data.password;
        }
      }

      async function fetchOtaStatus() {
        const data = await fetchInitialSectionConfig("ota");

        if (data) {
          document.getElementById("ota-status").textContent = data.status;
          document.getElementById("curr-version").textContent = data.curr_ver;
        }
      }

      function requestOta() {
        if (confirm("Do you want to upgrade firmware now?")) {
          const data = { request: "Update" };
          sendData("/api/ota-request", data, 1);
          alert(
            "Request to start network upgrade sent, press [Updat Status] to see progress",
          );
        }
      }

      async function fetchDeviceNameInitialConfig() {
        const data = await fetchInitialSectionConfig("device-name");

        if (data) {
          document.getElementById("device-name").value = data.name;
        }
      }

      async function fetchDisplayInitialConfig() {
        const data = await fetchInitialSectionConfig("display");

        if (data) {
          document.getElementById("dimming-timeout").value =
            data.dimming_timeout;
          document.getElementById("dimming-percent").value =
            data.dimming_percent;
          document.getElementById("blackout-timeout").value =
            data.blackout_timeout;
        }
      }

      async function fetchPrinterInitialConfig() {
        const data = await fetchInitialSectionConfig("printer");

        if (data) {
          loadPrinterSettings(data);
        }
      }

      // Function to reset the device
      function restartDevice() {
        const data = {};
        sendData("/api/reset-device", data, 1);
        alert(
          "Device restarted. Reactivate Web Config from device and refresh page to continue configuration",
        );
      }

      // Function to collect WiFi settings and send them as JSON
      function applyWiFiSettings() {
        const ssid = document.getElementById("wifi-ssid").value;
        const password = document.getElementById("wifi-password").value;
        const data = { ssid, password };
        const applyButton = document.getElementById("wifi-section-apply");
        sendConfigData("/api/wifi-config", data, applyButton); // Replace with actual server endpoint
      }

      function applyDeviceNameSettings() {
        const name = document.getElementById("device-name").value;
        const data = { name };
        const applyButton = document.getElementById(
          "device-name-apply",
        );
        sendConfigData("/api/device-name-config", data, applyButton); // Replace with actual server endpoint
      }

      function filterDnsName(el) {
        el.value = el.value
          .toLowerCase()
          .replace(/[^a-z0-9-]/g, "") // remove invalid chars
          .replace(/^-+/, ""); // trim leading hyphens (trailing also not allowed, but during typing it is there)
      }

      function applyFixedSecurityKeySettings() {
        const key = document.getElementById("fixed-security-key").value;
        const data = { key };
        const applyButton = document.getElementById("set-fixed-key-apply");
        sendConfigData("/api/fixed-key-config", data, applyButton); // Replace with actual server endpoint
      }

      // Function to collect Display settings and send them as JSON
      function applyDisplaySettings() {
        const dimming_timeout = parseInt(
          document.getElementById("dimming-timeout").value,
        );
        const dimming_percent = parseInt(
          document.getElementById("dimming-percent").value,
        );
        const blackout_timeout = parseInt(
          document.getElementById("blackout-timeout").value,
        );
        const data = { dimming_timeout, dimming_percent, blackout_timeout };
        const applyButton = document.getElementById("display-section-apply");
        sendConfigData("/api/display-config", data, applyButton); // Replace with actual server endpoint
      }

      // Function to collect Printer settings and send them as JSON
      function applyPrintersSettings() {
        const data = generatePrinterData();
        if (!data) return;
        const applyButton = document.getElementById("printers-apply");
        sendConfigData("/api/printer-config", data, applyButton); // Replace with actual server endpoint
      }
    </script>

    <script>
      // ==========================================
      // Initialization
      // ==========================================
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize the form with data from server

        // Add the first printer (cannot be removed)
        const firstPrinter = createPrinterTemplate(1, true);
        document.getElementById("printers-container").appendChild(firstPrinter);
        updatePrinterNumbers();
        setupChangeListeners("wifi-section", "wifi-section-apply");
        setupChangeListeners(
          "verify-key-section",
          "verify-key-button",
          "security-key-feedback",
        );
        setupChangeListeners("set-fixed-key-section", "set-fixed-key-apply");
        setupChangeListeners("display-section", "display-section-apply");
        setupChangeListeners("printers-container", "printers-apply");
        setupChangeListeners("spools-section", "spools-apply");
        setupChangeListeners("filaments-section", "filaments-apply");
        setupChangeListeners("scale-section", "scale-apply");
        setupChangeListeners("device-name-section", "device-name-apply");
        // Setup IP fields
        setupIPFields(document.querySelectorAll(".ip-part"));

        handleCSVTextAreaInput(null, 'spools-text', 'spools-chars-left', 2000);
        handleCSVTextAreaInput(null, 'custom-filaments-text', 'custom-filaments-chars-left', 4000);
      });

      function getHashParam(key) {
        const params = new URLSearchParams(location.hash.slice(1));
        return params.get(key) ?? null;
      }

      function setupChangeListeners(sectionId, buttonId, feedbackLabelId) {
        const section = document.getElementById(sectionId);
        const applyButton = document.getElementById(buttonId);
        section.addEventListener("input", () => {
          applyButton.disabled = false;
          if (feedbackLabelId) {
            const feedbackLabel = document.getElementById(feedbackLabelId);
            feedbackLabel.textContent = "";
          }
        });
      }

      function togglePasswordVisibility(inputId, toggleButton) {
        const passwordInput = document.getElementById(inputId);

        if (passwordInput.type === "password") {
          passwordInput.type = "text";
          toggleButton.textContent = "üîí";
        } else {
          passwordInput.type = "password";
          toggleButton.textContent = "üëÅÔ∏è";
        }
      }

      // ==========================================
      // Printer Settings Functions
      // ==========================================
      // Template for the printer form
      function createPrinterTemplate(id, isRemovable = true) {
        const template = document.createElement("div");
        template.className = "printer-form";
        template.dataset.id = id;

        template.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                  <h3>Printer <span class="printer-number">${id}</span></h3>
                  ${isRemovable ? '<button class ="remove-btn" type="button" onclick="removePrinter(' + id + ')">Remove</button>' : ""}
                  <button class="add-btn" style="margin-left:auto" type="button" onclick="addPrinterAbove(this)">Add Printer Above</button>
                </div>

                <div class="form-row">
                    <label>Serial Number: *</label>
                    <input type="text" class="serial" placeholder="Enter serial number">
                    <div class="error-message serial-error">Serial number is required</div>
                </div>

                <div class="form-row">
                    <label>Access Code: *</label>
                    <input type="text" class="access-code" placeholder="Enter access code">
                    <div class="error-message access-code-error">Access code is required</div>
                </div>

                <div class="form-row">
                    <label>Name:<span>Also used for multiprinter select</span></label>
                    <input type="text" class="name" autocomplete="off" spellcheck="false" autocapitalize="off" autocorrect="off" placeholder="Enter printer name">
                    <div class="error-message name-error">Name is required when IP is provided</div>
                </div>

                <div class="form-row">
                    <label>IP Address:<span>If set, requires also name</span></label>
                    <div class="ip-container">
                        <div class="ip-segment">
                            <input type="text" class="ip-part" maxlength="3" placeholder="000">
                        </div>
                        <div class="ip-segment">
                            <input type="text" class="ip-part" maxlength="3" placeholder="000">
                        </div>
                        <div class="ip-segment">
                            <input type="text" class="ip-part" maxlength="3" placeholder="000">
                        </div>
                        <div class="ip-segment">
                            <input type="text" class="ip-part" maxlength="3" placeholder="000">
                        </div>
                    </div>
                    <div class="error-message ip-error">IP requires name to be provided</div>
                </div>

                <div class = "form-row" >
                  <div style="display: flex; align-items: center; margin-bottom: 0px; margin-top: 0px; padding-bottom: 0px;">
                    <input class="track-print-consume" type="checkbox" id="tack-print-consume" checked>
                    <label for="track-print-consume" style="margin-top: 0px; margin-bottom:0px; padding-left: 2px;">Track Prints Filament Consumption</label>
                  </div>
                  <div style="display: flex; align-items: center; margin-left: 1.2rem; margin-bottom: 0px; margin-top: 6px; padding-bottom: 0px;">
                    <label for="fetch-3mf" style="margin-top: 0px; margin-bottom:0px; padding-left: 2px;">Default Fetch 3MF From</label>
                    <select style="padding-right: 12px; height: 20px; font-size: 1rem; margin-left: 12px;" class="fetch-3mf" type="checkbox" id="fetch-3mf">
                      <option value="printer-ftp">FTP (No Authorization)&nbsp;</option>
                      <option value="cloud-http">HTTP (Only in Cloud)</option>
                    </select>
                  </div>
                </div>
                <div class = "form-row">
                  <div style="display: flex; align-items: center; margin-bottom: 0px;">
                    <input class="auto-restore-k" type="checkbox" id="auto-restore-k">
                    <label for="auto-restore-k" style="margin-top: 0px; margin-bottom: 0px; padding-left: 2px;">Auto Restore K Values On Printer Restart</label>
                  </div>
                  <span>Use only with X1 printer, if it forgets K on restart.</span>
                </div>
                <div class = "form-row">
                  <div style="display: flex; align-items: center; margin-bottom: 0px;">
                    <input class="printer-log-filter" type="checkbox" id="printer-log-filter">
                    <label for="printer-log-filter" style="margin-top: 6px; padding-left: 2px;">Enable Extra  Printer  Logs</label>
                  </div>
                  <span >Only check if necessary; this will slow down the system!</span>
                </div>

                <div style="display: flex; align-items: center;">
                  <button class="default-btn" type="button" onclick="setAsDefault(${id})">Set as Default</button>
                  <button class="add-btn" style="margin-left:auto" type="button" onclick="addPrinterBelow(this)">Add Printer Below</button>
                </div>
            `;

        return template;
      }

      let defaultPrinter = null;
      function loadPrinterSettings(printersConfig) {
        // Clear existing printers
        const printersContainer = document.getElementById("printers-container");
        printersContainer.innerHTML = "";

        // Reset default
        defaultPrinter = null;

        // Add printers from the data
        printersConfig.printers.forEach((printer, index) => {
          const isFirst = index === 0;
          const newPrinterForm = createPrinterTemplate(index + 1, true);
          printersContainer.appendChild(newPrinterForm);

          // Fill in the printer data
          newPrinterForm.querySelector(".serial").value = printer.serial || "";
          newPrinterForm.querySelector(".access-code").value =
            printer.access_code || "";
          newPrinterForm.querySelector(".name").value = printer.name || "";

          // Set IP if available
          if (printer.ip) {
            const ipParts = printer.ip.split(".");
            const ipInputs = newPrinterForm.querySelectorAll(".ip-part");

            for (
              let i = 0;
              i < Math.min(ipParts.length, ipInputs.length);
              i++
            ) {
              ipInputs[i].value = ipParts[i];
            }
          }

          var logsEnabled = false;
          if (printer.log_filter) {
            switch (printer.log_filter) {
              case "OFF":
              case "ERROR":
              case "WARN":
                logsEnabled = false;
                break;
              default:
                logsEnabled = true;
            }
          }
          newPrinterForm.querySelector(".printer-log-filter").checked =
            logsEnabled;
          newPrinterForm.querySelector(".auto-restore-k").checked = printer.auto_restore_k;
          newPrinterForm.querySelector(".track-print-consume").checked = printer.track_print_consume;
          newPrinterForm.querySelector(".fetch-3mf").value = printer.fetch_3mf;
        });

        // Setup IP fields for all printers
        setupIPFields(document.querySelectorAll(".ip-part"));

        // Set the default printer if specified
        if (printersConfig.default_printer_serial) {
          const defaultSerial = printersConfig.default_printer_serial;
          document.querySelectorAll(".printer-form").forEach((form) => {
            const serial = form.querySelector(".serial").value;
            if (serial === defaultSerial) {
              const id = form.dataset.id;
              setAsDefault(id);
            }
          });
        }
        updatePrinterNumbers();
      }

      // Function to restrict IP fields to numbers only
      function setupIPFields(ipFields) {
        ipFields.forEach((field) => {
          field.addEventListener("keypress", function (e) {
            // Only allow numbers
            if (!/[0-9]/.test(e.key)) {
              e.preventDefault();
            }

            // Auto-move to next input after 3 digits
            if (this.value.length >= 3 && e.key !== "Tab") {
              const nextInput =
                this.parentElement.nextElementSibling?.querySelector("input");
              if (nextInput) {
                nextInput.focus();
              }
            }
          });

          field.addEventListener("input", function () {
            // Ensure value is between 0-255
            let val = parseInt(this.value, 10);
            if (isNaN(val)) {
              this.value = "";
            } else if (val > 255) {
              this.value = "255";
            }
          });
        });
      }

      function newPrinterForm() {
        const printersContainer = document.getElementById("printers-container");
        const currentCount = printersContainer.children.length;
        const newId = currentCount + 1;
        const newPrinterForm = createPrinterTemplate(newId, true);
        // Setup IP fields for the new printer
        setupIPFields(newPrinterForm.querySelectorAll(".ip-part"));
        return newPrinterForm;
      }
      function addPrinterAbove(me) {
        const parent = me.parentElement.parentElement;
        parent.insertAdjacentElement("beforebegin", newPrinterForm());
        updatePrinterNumbers();
      }

      function addPrinterBelow(me) {
        const parent = me.parentElement.parentElement;
        parent.insertAdjacentElement("afterend", newPrinterForm());
        updatePrinterNumbers();
      }

      function removePrinter(id) {
        const printerForm = document.querySelector(
          `.printer-form[data-id="${id}"]`,
        );

        // If this is the default printer, clear the default
        if (printerForm.classList.contains("default")) {
          defaultPrinter = null;
        }

        printerForm.remove();

        // Update all printer numbers and IDs
        updatePrinterNumbers();

        const printersApplyButton = document.getElementById("printers-apply");
        printersApplyButton.disabled = false;
      }

      function updatePrinterNumbers() {
        const printerForms = document.querySelectorAll(".printer-form");
        const showRemoveButton = printerForms.length > 1;

        printerForms.forEach((form, index) => {
          const newId = index + 1;

          // Update the ID attribute
          form.dataset.id = newId;

          // Update the printer number text
          form.querySelector(".printer-number").textContent = newId;

          // Update the onClick handlers
          const defaultBtn = form.querySelector(".default-btn");
          defaultBtn.setAttribute("onclick", `setAsDefault(${newId})`);

          const removeBtn = form.querySelector(".remove-btn");
          if (removeBtn) {
            if (showRemoveButton) {
              removeBtn.style = "display: block;";
            } else {
              removeBtn.style = "display: none;";
            }
            removeBtn.setAttribute("onclick", `removePrinter(${newId})`);
          }

          // If this was the default printer, update the defaultPrinter variable
          if (form.classList.contains("default")) {
            defaultPrinter = newId;
          }
        });
      }

      function setAsDefault(id) {
        // Remove default class from all printer forms
        document.querySelectorAll(".printer-form").forEach((form) => {
          form.classList.remove("default");
          const defaultBtn = form.querySelector(".default-btn");
          defaultBtn.classList.remove("active");
          defaultBtn.textContent = "Set as Default";
        });

        // Set this printer as default
        const printerForm = document.querySelector(
          `.printer-form[data-id="${id}"]`,
        );
        printerForm.classList.add("default");
        const defaultBtn = printerForm.querySelector(".default-btn");
        defaultBtn.classList.add("active");
        defaultBtn.textContent = "Default Printer";

        defaultPrinter = id;
      }

      function validatePrinterForms() {
        let isValid = true;

        // Hide all error messages first
        document.querySelectorAll(".error-message").forEach((msg) => {
          msg.style.display = "none";
        });

        // Validate each printer form
        document.querySelectorAll(".printer-form").forEach((form) => {
          const serialInput = form.querySelector(".serial");
          const accessCodeInput = form.querySelector(".access-code");
          const nameInput = form.querySelector(".name");
          const ipParts = Array.from(form.querySelectorAll(".ip-part"));

          // Check required fields
          if (!serialInput.value.trim()) {
            form.querySelector(".serial-error").style.display = "block";
            isValid = false;
          }

          if (!accessCodeInput.value.trim()) {
            form.querySelector(".access-code-error").style.display = "block";
            isValid = false;
          }

          // Check if any IP part is filled
          const hasIPValue = ipParts.some((part) => part.value.trim() !== "");

          // Check if all IP parts are filled or all are empty
          const ipFilled = ipParts.every((part) => part.value.trim() !== "");
          const ipEmpty = ipParts.every((part) => part.value.trim() === "");

          if (hasIPValue && !ipFilled) {
            form.querySelector(".ip-error").textContent =
              "All IP fields must be filled";
            form.querySelector(".ip-error").style.display = "block";
            isValid = false;
          }

          // If IP is provided, name is required
          if (hasIPValue && !nameInput.value.trim()) {
            form.querySelector(".name-error").style.display = "block";
            isValid = false;
          }
        });

        return isValid;
      }

      function generatePrinterData() {
        if (!validatePrinterForms()) {
          alert(
            "Please fix the printer validation errors before applying settings.",
          );
          return null;
        }

        const printers = [];
        let defaultPrinterSerial = null;

        document.querySelectorAll(".printer-form").forEach((form) => {
          const serial = form.querySelector(".serial").value.trim();
          const accessCode = form.querySelector(".access-code").value.trim();
          const name = form.querySelector(".name").value.trim();
          const logFilterEnabled = form.querySelector(
            ".printer-log-filter",
          ).checked;
          const autoRestoreK = form.querySelector(".auto-restore-k").checked;
          const trackPrintConsume = form.querySelector(".track-print-consume").checked;
          const fetch3mf = form.querySelector(".fetch-3mf").value;

          const ipParts = Array.from(form.querySelectorAll(".ip-part"));
          const ipValid = ipParts.every((part) => part.value.trim() !== "");

          let ip = null;
          if (ipValid) {
            ip = ipParts.map((part) => part.value.trim()).join(".");
          }

          const printer = {
            serial: serial,
            access_code: accessCode,
          };

          if (name) {
            printer.name = name;
          }

          if (ip) {
            printer.ip = ip;
          }

          if (logFilterEnabled) {
            printer.log_filter = "TRACE";
          } else {
            printer.log_filter = "WARN";
          }

          printer.auto_restore_k = autoRestoreK;
          printer.track_print_consume = trackPrintConsume;
          printer.fetch_3mf = fetch3mf;

          printers.push(printer);

          // Check if this is the default printer
          if (form.classList.contains("default")) {
            defaultPrinterSerial = serial;
          }
        });

        // Create the final JSON object
        const jsonData = { printers: printers };

        // Add default_printer_serial if set
        if (defaultPrinterSerial) {
          jsonData.default_printer_serial = defaultPrinterSerial;
        }

        return jsonData; // not really json, it's an object here
      }

      // Spools Section
      function handleCSVTextAreaInput(event, textAreaId, charsLeftId, maxChars) {
        const csvTextArea = document.getElementById(textAreaId);
        if (csvTextArea.value.length > maxChars) {
          csvTextArea.value = csvTextArea.value.substring(0, maxChars); // Trim excess characters
        }
        if (csvTextArea.clientHeight < csvTextArea.scrollHeight) {
          csvTextArea.style.height = "auto";
          csvTextArea.style.height = csvTextArea.scrollHeight + "px";
        }
        let charsUsed = csvTextArea.value.length;
        document.getElementById(charsLeftId).textContent =
          `${charsUsed} / ${maxChars}`;
      }

      function validateCSV(text, firstColRegex, secondColRegex) {
        if (text.trim() == "") {
          return true;
        }
        const lines = text.trim().split("\n");

        for (const line of lines) {
          const parts = line.split(",");
          if (parts.length !== 2) return false; // Ensure exactly two columns

          firstColumn = parts[0].trim();
          if (!firstColRegex.test(firstColumn)) return false;

          const secondColumn = parts[1].trim();
          if (!secondColRegex.test(secondColumn)) return false;
        }

        return true;
      }

      function applySpoolsSettings() {
        const spools = document.getElementById("spools-text").value;
        if (!validateCSV(spools, /^.*$/, /^\d{1,4}$/)) {
          alert("Invalid spools information");
          return;
        }
        const applyButton = document.getElementById("spools-apply");
        const data = { spools };
        sendConfigData("/api/spools-config", data, applyButton);
      }

      async function fetchSpoolsInitialConfig() {
        const data = await fetchInitialSectionConfig("spools");

        if (data) {
          document.getElementById("spools-text").value = data.spools;
          handleCSVTextAreaInput(null, 'spools-text', 'spools-chars-left', 2000);
        }
      }

      function validateCSV5(text, firstColRegex, secondColRegex, thirdColRegex, forthColRegex, fifthColRegex) {
        if (text.trim() == "") {
          return true;
        }
        const lines = text.trim().split("\n");

        for (const line of lines) {
          const parts = line.split(",");
          if (parts.length !== 5) return false; // Ensure exactly five columns

          firstColumn = parts[0].trim();
          if (!firstColRegex.test(firstColumn)) return false;

          const secondColumn = parts[1].trim();
          if (!secondColRegex.test(secondColumn)) return false;

          const thirdColumn = parts[2].trim();
          if (!thirdColRegex.test(thirdColumn)) return false; 

          const forthColumn = parts[3].trim();
          if (!forthColRegex.test(forthColumn)) return false;

          const fifthColumn = parts[4].trim();
          if (!fifthColRegex.test(fifthColumn)) return false;
        }

        return true;
      }

      function applyFilamentsSettings() {
        const custom_filaments = document.getElementById("custom-filaments-text").value;
        if (!validateCSV5(custom_filaments, /^.*$/, /^.*$/, /^\d+$/, /^\d+$/, /^.*$/)) {
          alert("Invalid custom filaments information");
          return;
        }
        const applyButton = document.getElementById("filaments-apply");
        const data = { custom_filaments };
        sendConfigData("/api/filaments-config", data, applyButton);
      }

      async function fetchFilamentsInitialConfig() {
        const data = await fetchInitialSectionConfig("filaments");

        if (data) {
          document.getElementById("custom-filaments-text").value = data.custom_filaments;
          handleCSVTextAreaInput(null, 'custom-filaments-text', 'custom-filaments-chars-left', 4000);
        }
      }

      function selectAndProcessCustomFilaments() {
          const folderInput = document.getElementById('folderInput');
          folderInput.value = '';
          folderInput.click();
      }

      async function processFiles() {
          const input = document.getElementById("folderInput");
          const files = Array.from(input.files);
          const fileMap = new Map();
          for (const file of files) fileMap.set(file.webkitRelativePath, file);

          const uniqueFilamentIds = new Set();
          const results = [];

          for (const [path, file] of fileMap) {
            if (!path.endsWith(".info")) continue;
            const text = await file.text();
            const lines = text.split("\n");

            const baseIdLine = lines.find((l) => l.startsWith("base_id ="));
            const baseId = baseIdLine?.split("=")[1]?.trim() ?? "";
            if (baseId) continue;

            const jsonPath = path.replace(/\.info$/, ".json");
            const jsonFile = fileMap.get(jsonPath);
            if (!jsonFile) continue;

            try {
              const json = JSON.parse(await jsonFile.text());
              const filamentId = (json.filament_id ?? "").toString().trim();
              if (!filamentId || uniqueFilamentIds.has(filamentId)) continue;

              let name = (json.name ?? "").toString().trim();
              name = name.split("@")[0].trim();

              let nozzle_temp_low = json.nozzle_temperature_range_low?.[0] ?? "";
              let nozzle_temp_high = json.nozzle_temperature_range_high?.[0] ?? "";
              let filament_type = json.filament_type?.[0] ?? "";
              
              results.push(`${filamentId},${csvEscape(name)},${nozzle_temp_low},${nozzle_temp_high},${filament_type}`);
              uniqueFilamentIds.add(filamentId);
            } catch {}
          }

          document.getElementById("custom-filaments-text").value = results.join("\n");
          handleCSVTextAreaInput(event, 'custom-filaments-text', 'custom-filaments-chars-left', 4000);
      }

      function csvEscape(value) {
        if (/[",\n\r]/.test(value)) {
          return `"${value.replace(/"/g, '""')}"`;
        }
        return value;
      }

      function applyScaleSettings() {
        const scaleForm = document.getElementById("scale-section");
        const key = document.getElementById("scale-key").value;
        const name = document.getElementById("scale-name").value;
        const available = document.getElementById("scale-available").checked; 
        const ipParts = Array.from(scaleForm.querySelectorAll(".ip-part"));
        const ipValid = ipParts.every((part) => part.value.trim() !== "");

        let ip = null;
        if (ipValid) {
          ip = ipParts.map((part) => part.value.trim()).join(".");
        }

        const applyButton = document.getElementById("scale-apply");
        const data = { available, name, ip, key };
        sendConfigData("/api/scale-config", data, applyButton);
      }

      async function fetchScaleInitialConfig() {
        const scaleForm = document.getElementById("scale-section");
        const data = await fetchInitialSectionConfig("scale");

        if (data.available) {
          document.getElementById("scale-available").checked = data.available;
        } else {
          document.getElementById("scale-available").checked = false;
        }
        // Set IP if available
        if (data.ip) {
          const ipParts = data.ip.split(".");
          const ipInputs = scaleForm.querySelectorAll(".ip-part");

          for (let i = 0; i < Math.min(ipParts.length, ipInputs.length); i++) {
            ipInputs[i].value = ipParts[i];
          }
        }

        if (data) {
          document.getElementById("scale-name").value = data.name;
        }
        if (data) {
          document.getElementById("scale-key").value = data.key;
        }
      }
    </script>

    <!-- for debugging -->
    <script>
      var urlPrefix = "";
      // for local debugging case
      window.addEventListener("DOMContentLoaded", () => {
        const installButton = document.getElementById("install-button");
        if (
          window.location.hostname === "localhost" ||
          window.location.hostname === "127.0.0.1"
        ) {
          urlPrefix = "http://consoledev.local";
        }
      });
    </script>
  </body>
</html>
